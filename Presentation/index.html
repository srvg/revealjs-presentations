
<!doctype html>
<html lang="en">

        <head>
                <meta charset="utf-8">

                <title>Introduction to the ansible inventory</title>

                <meta name="description" content="How does Ansible model its inventory data and how can we use it?">
                <meta name="author" content="Serge van Ginderachter">

                <meta name="apple-mobile-web-app-capable" content="yes" />
                <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

                <link rel="stylesheet" href="css/reveal.min.css">
                <link rel="stylesheet" href="css/theme/default.css" id="theme">

                <!-- For syntax highlighting -->
                <link rel="stylesheet" href="lib/css/zenburn.css">

                <!-- If the query includes 'print-pdf', use the PDF print sheet -->
                <script>
                  if( window.location.search.match( /print-pdf/gi ) ) {
                    var link = document.createElement( 'link' );
                    link.rel = 'stylesheet';
                    link.type = 'text/css';
                    link.href = 'css/print/pdf.css';
                    document.getElementsByTagName( 'head' )[0].appendChild( link );
                  }
                </script>

                <!--[if lt IE 9]>
                <script src="lib/js/html5shiv.js"></script>
                <![endif]-->
        </head>

        <body>

     <div class="reveal">

                        <!-- Any section element inside of this container is displayed as a slide -->
                        <div class="slides">

<section data-background='#000000' data-transition='linear'>
<h2 >
Introduction to the ansible inventory</h2>
<h5 >
How does Ansible model its inventory and how can we model our infrastructure?</h5>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
$ whoami</h3>
<ul><br><li >Serge van Ginderachter - @svg</li><br><li >www.ginsys.eu - serge@ginsys.eu</li><br><li >svg on Freenode</li></ul><p><img src='images/ginsys_def_Logo neg liggend bw.jpg' style='border:0px;background-color:#000000' ></p></section><section data-background='#000000' data-transition='linear'>
<h3 >
$WORK</h3>
<h3 >
Infrastructure "consultant"</h3>
<ul><br><li >Serge van Ginderachter</li><br><li >Ansible user and contributor since 2012 </li><br><li >github.com/srvg</li><br><li >github.com/ginsys</li></ul><pre><code contenteditable >
commit da92ce796b48ec80e3ead1cfe9bcbc71f5fce805
Author Serge van Ginderachter
Date   Wed Oct 10 19:38:30 2012 +0200

  fix missing --limit in docssite examples

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
Ansible Inventory</h3>
<p >
How can this thing be implemented?</p>
<pre><code contenteditable >
~/src/ansible/lib/ansible$ ls inventory/
dir.py
expand_hosts.py
group.py
host.py
ini.py
__init__.py
script.py
vars_plugins

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
ansible.inventory</h3>
<pre><code contenteditable >
96         elif os.path.exists(host_list):
97             if os.path.isdir(host_list):
98                 # Ensure basedir is inside the directory
99                 self.host_list = os.path.join(self.host_list, "")
100                 self.parser = InventoryDirectory(filename=host_list)
101                 self.groups = self.parser.groups.values()
102             elif utils.is_executable(host_list):
103                 self.parser = InventoryScript(filename=host_list)
104                 self.groups = self.parser.groups.values()
105             else:
106                 self.parser = InventoryParser(filename=host_list)
107                 self.groups = self.parser.groups.values()
108
109             utils.plugins.vars_loader.add_directory(self.basedir(), with_subdir=True)

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
ansible.inventory.dir</h3>
<pre><code contenteditable >
58             if os.path.isdir(fullpath):
59                 parser = InventoryDirectory(filename=fullpath)
60             elif utils.is_executable(fullpath):
61                 parser = InventoryScript(filename=fullpath)
62             else:
63                 parser = InventoryParser(filename=fullpath)
64             self.parsers.append(parser)

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
~/src/ansible/examples/hosts</h3>
<pre><code contenteditable >
# This is the default ansible 'hosts' file.

# Ungrouped hosts, specify before any group headers.
green.example.com
blue.example.com
192.168.100.1
192.168.100.10

# A collection of hosts belonging to the 'webservers' group
[webservers_A]
alpha.example.org
beta.example.org

[webservers_B]
192.168.1.100
192.168.1.110

# A collection of database servers in the 'dbservers' group
[dbservers]

db01.intranet.mydomain.net
db02.intranet.mydomain.net
10.25.1.56
10.25.1.57

# groups can have child groups, too
[webservers:children]
webservers_A
webservers_B

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
Dynamic inventory scripts</h3>
<pre><code contenteditable >
{
    "databases"   : {
        "hosts"   : [ "host1.example.com", "host2.example.com" ],
        "vars"    : {
            "a"   : true
        }
    },
    "webservers"  : [ "host2.example.com", "host3.example.com" ],
    "atlanta"     : {
        "hosts"   : [ "host1.example.com", "host4.example.com", "host5.example.com" ],
        "vars"    : {
            "b"   : false
        },
        "children": [ "marietta", "5points" ],
    },

    "marietta"    : [ "host6.example.com" ],
    "5points"     : [ "host7.example.com" ]

    "_meta" : {
       "hostvars" : {
          "moocow.example.com"     : { "asdf" : 1234 },
          "llama.example.com"      : { "asdf" : 5678 },
       }
    }
}

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
The Ansible inventory is not a tree!</h3>
<pre><code contenteditable >
google
google/gcalendar
google/gcalendar/backend
google/gcalendar/backend/storage1
google/gcalendar/backend/storage2
google/gcalendar/backend/storage3
google/gcalendar/frontend
google/gcalendar/frontend/web1
google/gcalendar/frontend/web2
google/gcalendar/frontend/web3
google/gdrive
google/gdrive/backend
google/gdrive/backend/storage1
google/gdrive/backend/storage2
google/gdrive/backend/storage3
google/gdrive/frontend
google/gdrive/frontend/web1
google/gdrive/frontend/web2
google/gdrive/frontend/web3
google/gmail
google/gmail/backend
google/gmail/backend/storage1
google/gmail/backend/storage2
google/gmail/backend/storage3
google/gmail/frontend
google/gmail/frontend/web1
google/gmail/frontend/web2
google/gmail/frontend/web3

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
Nodes can live in different groups on different levels</h3>
<pre><code contenteditable >
google/nginx
google/nginx/web1
google/nginx/web2
google/nginx/web3
google/tomcat
google/tomcat/storage1
google/tomcat/storage2
google/tomcat/storage3

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
internal Ansible inventory model</h3>
<pre><code contenteditable >
web1:
  groups:
   - all
   - google
   - gcalendar
   - gdrive
   - gmail
   - frontend
storage2:
   groups:
   - all
   - google
   - gcalendar
   - gdrive
   - gmail
   - backend

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
internal Ansible inventory model - 2</h3>
<pre><code contenteditable >
web1:
  groups:
       - groupname: all
         depth: 0
       - groupname: google
         depth: 1
       - groupname: gcalendar
         depth: 2
       - groupname: gdrive
         depth: 2
       - groupname: gmail
         depth: 2
       - groupname: frontend
         depth: 3

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
internal Ansible inventory model - 3</h3>
<pre><code contenteditable >
storage2:
  groups:
       - groupname: all
         depth: 0
       - groupname: google
         depth: 1
       - groupname: gcalendar
         depth: 2
       - groupname: gdrive
         depth: 2
       - groupname: gmail
         depth: 2
       - groupname: frontend
         depth: 3

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
How about Inventory variable precedence?</h3>
<ul><br><li >Ansible docs are very succinct on how inventory variables precede each other</li><br><li >Because As all things Ansible, KEEP IT SIMPLE, they say.</li></ul><blockquote >There is only one Empire State Building. One Mona Lisa, etc. Figure out where to define a variable, and do not make it complicated.</blockquote><blockquote >Remember: Child groups override parent groups, and hosts always override their groups.</blockquote></section><section data-background='#000000' data-transition='linear'>
<h3 >
So ansible inventory is not a tree</h3>
<h3 >
but variables precede in child groups?</h3>
<ul><br><li >Child? Parent? Tree?</li></ul><pre><code contenteditable >
35     def add_child_group(self, group):
40         # do not add if it is already there
41         if not group in self.child_groups:
42             self.child_groups.append(group)
43             group.depth = max([self.depth+1, group.depth])
44             group.parent_groups.append(self)
45             self.clear_hosts_cache()

</pre></code>
<ul><br><li >When we encounter a child group, then "depth" gets a level deeper; the deeper the child the more precedence</li><br><li >That *is* some kind of a tree, no?</li></ul></section><section data-background='#000000' data-transition='linear'>
<h3 >
Current project</h3>
<ul><br><li >80% of all virtual machines are tomcat hosts based on ONE ROLE</li><br><li >every tomcat app is a two node "cluster" behind a loadbalancer</li><br><li >applications are part of a project, a project is part of an organisation</li><br><li >every application has three instances in each environment</li><br><li >ontwikkel - oefen - productie</li></ul></section><section data-background='#000000' data-transition='linear'>
<h3 >
inventory organisation</h3>
<pre><code contenteditable >
all inventory
|_ organisation 1
   |_ project 1
      |_ application 1
         |_ dev
            |_ node 1
            |_ node 2
         |_ test
            |_ ..
         |_ prod
            |_ ..
      |_ application 2
            |_ ..
   |_ project 2
      |_ ..
|_ organisation 1
   |_ ..

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
other group trees (we have different tree's!)</h3>
<pre><code contenteditable >
|_ development
   |_ organisation1-dev
      |_application1-dev
|_ testing
|_ production

</pre></code>
<h6 >
or also</h6>
<pre><code contenteditable >
tomcat
|_ application1
|_ application2
drupal
|_ application7
|_ application9

</pre></code>
<p >
lowest groups with nodes are at different levels in different tree's</p>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
Example: a set of reverse proxies:</h3>
<pre><code contenteditable >
all(0)
. infra(1)
.. rp(2)
... rp-vonet-oe(3)
... rp-vonet-on(3)
... rp-vonet-pr(3)
... rp-innet-oe(3)
... rp-innet-on(3)
... rp-innet-pr(3)
.. rp-vonet(2)
... rp-vonet-on(3)
... rp-vonet-oe(3)
... rp-vonet-pr(3)
.. rp-innet(2)
... rp-innet-on(3)
... rp-innet-oe(3)
... rp-innet-pr(3)

</pre></code>
</section><section data-background='#000000' data-transition='linear'>
<h3 >
Managing inventory data</h3>
<p >
updating software versions of applications in different stacks, in different environments</p>
<ul><br><li >update default java version for all dev servers?</li><br><li >defaults can be dangerous!!</li><br><li >ini hosts file and host/group_vars don't scale well</li><br><li >a more advanced inventory that let's you inherit defaults, but then remember them for particular setup</li></ul></section><section data-background='#000000' data-transition='linear'>
<h1 >
Q/A ?</h1>
<p><img src='images/ginsys_def_Logo pos.png' style='border:0px;background-color:#000000' ></p></section><section data-background='#000000' data-transition='linear'>
<h1 >
Thanks!</h1>
<p><img src='images/ginsys_def_logotype pos.png' style='border:0px;background-color:#000000' ></p><blockquote >https://github.com/srvg/revealjs-presentations/tree/ansible-utrecht-meetup-150227/Presentation</blockquote></section>

                       </div>

                </div>

                <script src="lib/js/head.min.js"></script>
                <script src="js/reveal.min.js"></script>

                <script>

                        // Full list of configuration options available here:
                        // https://github.com/hakimel/reveal.js#configuration
                        Reveal.initialize({
                                controls: true,
                                progress: true,
                                history: true,
                                center: true,

                                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                                // Parallax scrolling
                                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                                // parallaxBackgroundSize: '2100px 900px',

                                // Optional libraries used to extend on reveal.js
                                dependencies: [
                                        { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                                        { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                                        { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                                        { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                                        { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                                        { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                                ]
                        });

                </script>

        </body>
</html>


